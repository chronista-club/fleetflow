# OrbStack連携 - 仕様書

最終更新日: 2025-11-22

## コンセプト

### ビジョン

FleetFlowにOrbStackとの連携機能を実装し、ローカル開発環境におけるコンテナのグループ化と視認性を向上させます。複数プロジェクトの並行開発を効率化し、開発者体験を改善します。

### 哲学・設計原則

- **ローカル開発ファースト**: macOS + OrbStackでの開発体験を最優先
- **Docker Compose互換**: 既存の標準に準拠し、他ツールとの相互運用性を確保
- **視認性の重視**: プロジェクト、ステージ、サービスの関係を一目で把握可能に
- **チーム開発の支援**: 統一された命名規則でチーム間の認識を共有

### 推奨利用環境

この機能は**主にローカル開発環境**での利用を想定しています：

- **ローカル開発**: 最も効果的な利用シーン（macOS + OrbStack）
- **チーム開発**: 統一された命名規則でチーム間の認識を共有
- **マルチプロジェクト**: 複数プロジェクトの並行開発を支援

> **注意**: 本番環境では、Kubernetes等の本格的なオーケストレーションツールの使用を推奨します。

## 背景と課題

### 課題

1. **コンテナ管理の煩雑さ**
   - OrbStackで複数プロジェクトのコンテナが混在すると管理が困難
   - Docker Composeと異なり、デフォルトではグループ化されない

2. **視認性の低さ**
   - プロジェクト、ステージ、サービスの関係が不明瞭
   - どのコンテナがどのプロジェクトに属するか分かりにくい

3. **開発効率の低下**
   - 目的のコンテナを見つけるのに時間がかかる
   - 誤って別プロジェクトのコンテナを操作するリスク

### 解決策

1. **Docker Compose互換のラベル自動付与**
   - `com.docker.compose.project`ラベルでグループ化
   - OrbStackが自動的に認識してグループ表示

2. **階層的な命名規則の採用**
   - `{project}-{stage}-{service}`形式
   - 一目でプロジェクト・環境・サービスを識別可能

3. **OrbStackのグループ化機能を活用**
   - ラベルベースでの自動グループ化
   - GUI経由での直感的な操作

## 仕様

### FS-001: コンテナ命名規則

**形式**:
```
{project}-{stage}-{service}
```

**例**:
- `vantage-local-surrealdb`
- `vantage-dev-qdrant`
- `estatebox-prod-api`
- `fleetflow-local-postgres`

**利点**:
- プロジェクトの識別が容易
- ステージ（環境）が明確
- サービスの役割が一目瞭然
- 名前の衝突を防止

### FS-002: Dockerラベル仕様

#### 必須ラベル（OrbStackグループ化用）

| ラベル名 | 値の形式 | 用途 |
|---------|---------|------|
| `com.docker.compose.project` | `{project}-{stage}` | OrbStackグループ化キー |
| `com.docker.compose.service` | `{service}` | サービス識別子 |

#### 追加ラベル（FleetFlowメタデータ）

| ラベル名 | 値 | 用途 |
|---------|-----|------|
| `fleetflow.project` | プロジェクト名 | プロジェクト識別 |
| `fleetflow.stage` | ステージ名 | 環境識別 |
| `fleetflow.service` | サービス名 | サービス識別 |

### FS-003: OrbStackでの表示

#### グループ化の仕組み
1. `com.docker.compose.project`ラベルでグループ化
2. 同じプロジェクト・ステージのコンテナが1つのグループに
3. グループ名：`{project}-{stage}`（例：`vantage-local`、`fleetflow-dev`）

#### 表示階層
```
📁 vantage-local
  ├── surrealdb
  ├── qdrant
  └── vantage-hub

📁 estatebox-local
  ├── postgres
  └── redis

📁 fleetflow-dev
  ├── postgres
  └── redis
```

### FS-004: ポート設定ガイドライン

プロジェクトごとに推奨ポート範囲を設定：

| プロジェクト | ポート範囲 | 用途 |
|-------------|-----------|------|
| vantage | 11000-11099 | Hub関連サービス |
| estatebox | 5432, 6333-6334 | データベース・ベクトルDB |
| fleetflow | 8080-8089 | 管理UI・API |

## 技術的メリット

### 1. 互換性

- Docker Compose標準のラベルを使用
- 他のツール（Portainer等）との相互運用性を確保
- 既存のDocker Compose設定との整合性

### 2. 拡張性

- 追加のメタデータラベルで将来の機能拡張に対応
- プロジェクト固有の情報を保持
- ラベルベースのフィルタリングに対応

### 3. 視認性

- 一貫性のある命名規則
- プロジェクト間の明確な分離
- 環境（ステージ）の識別が容易

## ローカル開発環境でのメリット

### なぜローカル環境に最適か

1. **macOS固有の最適化**
   - OrbStackはmacOS専用に最適化されている
   - Docker Desktopよりも軽量で高速

2. **開発効率の向上**
   - GUI経由での直感的なコンテナ管理
   - グループ単位での一括操作が可能
   - ログの確認やシェルアクセスが容易

3. **リソース管理**
   - メモリ使用量の削減
   - CPUリソースの効率的な利用
   - バッテリー消費の最小化

## 進化の方向性

### Phase 1（実装済み）
- [x] 基本的な命名規則
- [x] Dockerラベルの自動付与
- [x] OrbStackグループ化対応

### Phase 2（検討中）
- [ ] ラベルベースのフィルタリング
- [ ] 自動クリーンアップ
- [ ] プロジェクト間の依存関係管理

### Phase 3（将来）
- [ ] OrbStackネイティブ統合
- [ ] OrbStack API直接連携
- [ ] グループ単位での操作API

## まとめ

このOrbStack連携により、FleetFlowは以下を実現します：

1. **視認性の向上** - 階層的な命名とグループ化
2. **管理の簡素化** - プロジェクト単位での操作
3. **互換性の確保** - Docker Compose標準への準拠
4. **拡張性の確保** - 将来の機能追加への対応

特に**ローカル開発環境において**、複数プロジェクトの並行開発が格段に効率化されます。OrbStackのGUIと組み合わせることで、コンテナ管理の煩雑さから開発者を解放し、本来のコーディングに集中できる環境を提供します。

## 変更履歴

### 2025-11-22: ドキュメント構造変更
- **理由**: SDGスキルのフラット構造に対応
- **影響**: docs/design/から spec/, design/, guides/へ分割
- **コミット**: (未定)

### 2025-11-16: 初版作成
- **理由**: OrbStack連携機能の設計完了
- **影響**: コンテナ命名規則とラベル仕様の確定
- **コミット**: bddb58f
