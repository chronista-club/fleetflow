# Core Concept - Fleetflow仕様

## 概要

Fleetflowは、KDL（KDL Document Language）をベースにした、シンプルで強力な環境構築・デプロイツールです。
Docker Composeの手軽さを保ちつつ、より少ない記述で、より強力な設定管理を実現します。

## 設計原則

### 1. Convention over Configuration（設定より規約）

規約に従えば、多くの設定を省略できます。

```kdl
// 最小限の記述
service "postgres" {
    // image は自動的に postgres:latest が使われる
}
```

### 2. 宣言的な記述

状態を宣言するだけで、Fleetflowが適切に処理します。

```kdl
environment "production" {
    service "api" {
        image "myapp:1.0.0"
        replicas 3
    }
}
```

### 3. モジュール化と再利用

include機能で設定を分割・再利用できます。

```kdl
include "common/database.kdl"
include "common/redis.kdl"
```

## コアコンセプト

### Environment（環境）

アプリケーションが動作する環境を定義します。

```kdl
environment "development" {
    services ["api", "db", "redis"]
    variables {
        DEBUG "true"
        LOG_LEVEL "debug"
    }
}

environment "production" {
    services ["api", "db", "redis", "nginx"]
    variables {
        DEBUG "false"
        LOG_LEVEL "info"
    }
}
```

**特徴:**
- 複数の環境を1つのファイルで管理
- 環境ごとに異なるサービス構成
- 環境変数の管理

### Service（サービス）

コンテナ化されたアプリケーションやミドルウェアを定義します。

```kdl
service "api" {
    image "myapp:latest"
    version "1.0.0"

    ports {
        port 8080 3000  // host:container
    }

    environment {
        DATABASE_URL "postgresql://db:5432/mydb"
        REDIS_URL "redis://redis:6379"
    }

    volumes {
        volume "./data" "/app/data"
    }

    depends_on ["db", "redis"]
}
```

**特徴:**
- イメージの自動推測（service名からimage名を推測）
- ポート、環境変数、ボリュームの宣言的な定義
- サービス間の依存関係

### Port（ポート）

コンテナのポートマッピングを定義します。

```kdl
ports {
    port 8080 3000              // TCP（デフォルト）
    port 8443 3443 protocol="tcp"
    port 5432 5432 host_ip="127.0.0.1"  // localhostのみ
}
```

**パラメータ:**
- `host`: ホスト側のポート
- `container`: コンテナ側のポート
- `protocol`: TCP/UDP（デフォルト: TCP）
- `host_ip`: バインドするIPアドレス（デフォルト: 0.0.0.0）

### Volume（ボリューム）

永続化データやファイル共有を定義します。

```kdl
volumes {
    volume "./data" "/var/lib/postgresql/data"
    volume "./config" "/etc/myapp/config" read_only=true
}
```

**パラメータ:**
- `host`: ホスト側のパス
- `container`: コンテナ側のパス
- `read_only`: 読み取り専用フラグ（デフォルト: false）

## 規約（Convention）

### イメージ名の自動推測

サービス名から自動的にイメージ名を推測します。

```kdl
service "postgres" {
    // image "postgres:latest" が自動的に使われる
}

service "postgres" {
    version "16"
    // image "postgres:16" が使われる
}

service "redis" {
    // image "redis:latest" が自動的に使われる
}
```

### デフォルト値

多くのフィールドにはデフォルト値が設定されています。

- `protocol`: `tcp`
- `host_ip`: `0.0.0.0`
- `read_only`: `false`
- `ports`: `[]` (空配列)
- `volumes`: `[]` (空配列)
- `depends_on`: `[]` (空配列)
- `environment`: `{}` (空マップ)

### ファイル構造

```
project/
├── fleetflow.kdl              # メイン設定ファイル
├── common/                 # 共通設定
│   ├── database.kdl
│   └── redis.kdl
├── environments/           # 環境別設定
│   ├── dev.kdl
│   ├── staging.kdl
│   └── prod.kdl
└── services/               # サービス定義
    ├── api.kdl
    ├── worker.kdl
    └── frontend.kdl
```

## 完全な例

```kdl
// fleetflow.kdl

// 共通設定をインクルード
include "common/database.kdl"
include "common/redis.kdl"

// 変数定義
variables {
    app_version "1.0.0"
    registry "ghcr.io/myorg"
}

// サービス定義
service "api" {
    image "{registry}/api:{app_version}"

    ports {
        port 8080 3000
    }

    environment {
        NODE_ENV "production"
        DATABASE_URL "postgresql://db:5432/mydb"
        REDIS_URL "redis://redis:6379"
    }

    depends_on ["db", "redis"]
}

service "worker" {
    image "{registry}/worker:{app_version}"

    environment {
        NODE_ENV "production"
        DATABASE_URL "postgresql://db:5432/mydb"
        REDIS_URL "redis://redis:6379"
    }

    depends_on ["db", "redis"]
}

// 環境定義
environment "development" {
    services ["api", "db", "redis"]

    variables {
        DEBUG "true"
    }
}

environment "production" {
    services ["api", "worker", "db", "redis", "nginx"]

    variables {
        DEBUG "false"
    }
}
```

## 次のステップ

- [ ] 基本的なKDLパーサーの実装
- [ ] サービス定義のパース
- [ ] 環境定義のパース
- [ ] include機能の実装
- [ ] 変数展開の実装
- [ ] イメージ名の自動推測ロジック
