# Spec: 設定優先順位とポート管理要件

## 1. データ確定フロー (Data Resolution Flow)

FleetFlow は以下の順序で設定を確定させます（後に読み込まれるものが、既存の定義を上書きします）。

1.  **プロジェクトロード (`flow.kdl`)**:
    - プロジェクト共通の設定を適用し、基本となるサービス構成を構築します。
2.  **ステージロード (`flow.{stage}.kdl`)**:
    - 特定の実行環境 (dev/live 等) に固有の設定を適用します。
3.  **ローカルロード (`flow.local.kdl`)**:
    - **最高優先度**。開発者個人の環境差異や秘密情報を適用します。
4.  **環境変数注入 (`.env` / OS環境変数)**: 
    - 最終的な KDL 文字列に対してテンプレートエンジン (Tera) が変数展開を行い、データを確定させます。
    - システム環境変数 (`FLEETFLOW_*`) は `.env` よりも優先されます。

## 2. ポート競合解決とグレースフルシャットダウン

起動 (`up`) または再起動 (`restart`) 時、使用予定のホストポートが既に占有されている場合、以下の「グレースフル・クリーンアップ」を実行します。

### シャットダウンフロー
1.  **検出**: 指定ポートを使用しているプロセス (PID) またはコンテナを特定。
2.  **グレースフル終了要求**: 
    - プロセスに対しては `SIGTERM` を送信。
    - コンテナに対しては `docker stop` を実行。
3.  **待機と監視**: 最大 **5秒間**、ポートが解放されるのを監視（ポーリング）。
4.  **即時キャッチ**: 5秒待たずとも、ポートが解放されたことを検知した瞬間に次へ進む。
5.  **強制的終了**: 5秒経過しても解放されない場合、`SIGKILL` または `docker kill` を実行して強制解放する。

## 3. テスト要件
- 全ての統合テストにおいて、この「優先順位」と「ポート解放ロジック」が適用されていることを検証する。
- 意図的にポートを占有させた状態から `fleet up` が成功することを確認する。
