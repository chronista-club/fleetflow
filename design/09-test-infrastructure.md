# Design: テストインフラストラクチャ

## 1. ディレクトリ構造

実装コードと完全に分離するため、各主要クレートの `tests/` ディレクトリを使用します。

```
crates/fleetflow/
├── src/                # 実装コード
└── tests/              # 統合テスト（ここに追加）
    ├── common/         # テスト用ユーティリティ
    ├── cli_test.rs     # CLIコマンドのテスト
    └── integration.rs  # 全体連動テスト
```

## 2. 使用技術

- **`assert_cmd`**: バイナリとしての `fleetflow` コマンドを実行し、標準出力や終了コードを検証します。
- **`tempfile`**: テストごとに独立した一時ディレクトリを作成し、環境を汚染しないようにします。
- **`bollard`**: テストコードから直接 Docker デーモンの状態（コンテナの有無等）を検証します。
- **`predicates`**: 柔軟な文字列マッチング（正規表現等）に使用します。

## 3. テスト実行フロー

1.  **Setup**: `tempfile` で一時ディレクトリを作成。`fleet.kdl` を配置。
2.  **Execution**: `assert_cmd` で `fleet up <stage>` を実行。
3.  **Verification**: 
    - 終了コードが 0 であること。
    - `bollard` でコンテナが指定の名前・ラベルで存在することを確認。
4.  **Teardown**: `fleet down --remove` を実行（または Docker API で直接削除）。一時ディレクトリの削除。

## 4. 実装チェックリスト

- [ ] `assert_cmd`, `predicates`, `tempfile` の依存関係追加
- [ ] テスト用ユーティリティ（一時プロジェクト作成等）の実装
- [ ] `UC-01` (基本操作) のテスト実装
- [ ] `UC-02` (ワークロード) のテスト実装
- [ ] `UC-03` (二環境) のテスト実装
