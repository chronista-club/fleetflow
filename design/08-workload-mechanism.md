# Design: ワークロードの実装メカニズム

## 1. ファイル発見フェーズの拡張 (`fleetflow-core/src/discovery.rs`)

`discover_files` 関数を拡張し、`workload` ノードを事前にスキャンして関連ファイルを収集するようにします。

### 検索順序
1. メインの `flow.kdl` を読み込み、`workload "..." ` ノードを抽出。
2. 抽出されたワークロード名に基づき、`workloads/{name}.kdl` および `workloads/{name}/**/*.kdl` を探索。
3. 発見されたファイルを `DiscoveredFiles` のリストに追加。

## 2. ロードとマージの順序 (`fleetflow-core/src/loader.rs`)

以下の順序で KDL 文字列を結合し、パースを行います。

1. **ワークロード定義ファイル**: 基礎となる構成。
2. **プロジェクトのメイン設定 (`flow.kdl`)**: ワークロードの宣言と、プロジェクト固有のオーバーライド。
3. **ステージ/サービス定義ファイル**: さらに詳細な分割ファイル。
4. **ローカルオーバーライド (`flow.local.kdl`)**: 最終的な上書き。

## 3. データモデルの変更 (`fleetflow-core/src/model/`)

`Flow` 構造体に `workload` フィールドを追加することを検討します（必須ではありませんが、メタデータとして保持しておくと便利です）。

## 4. 懸念点と解決策

- **循環参照**: ワークロード内で別のワークロードを呼ぶことは、当面は制限するか、深度制限を設けます。
- **名前の衝突**: 異なるワークロードで同じ名前のサービスが定義されている場合、エラーにするか、後に読み込まれた方を優先するか明確なルールを設けます（基本は「後勝ち」）。
