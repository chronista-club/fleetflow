# unison-flow ワークフロー設計

## ブランチ戦略

### 永続ブランチ
- **master**: 最終リリースブランチ（デフォルト）
  - 本番環境にデプロイ可能な安定版
  - タグによるバージョン管理
  
- **edge**: 開発先端ブランチ
  - 最新の開発成果が統合される
  - 全ての機能開発はここから分岐
  - masterへの定期的なリリース

### 作業ブランチ
- **feature/<issue-id>-<description>**: 機能開発
  - edgeから分岐
  - 完了後edgeにマージ
  
- **hotfix/<issue-id>-<description>**: 緊急修正
  - masterから分岐
  - master及びedgeの両方にマージ

## ワークフローステップ

### 1. 開発開始 (start)
```bash
unison-flow start <issue-id>
```
1. Linear APIからissue情報を取得
2. issueタイプに基づいてブランチを作成
   - 通常: edgeから分岐
   - hotfix: masterから分岐
3. ブランチ名: `<type>/<issue-id>-<auto-generated-slug>`

### 2. 作業中 (work)
```bash
# 状態確認
unison-flow status

# コミット（自動的にissue IDを含める）
unison-flow commit -m "メッセージ"
```

### 3. レビュー準備 (review)
```bash
unison-flow pr
```
1. 変更内容の確認
2. PRの自動作成
3. Linear issueとの自動リンク
4. レビュアーの自動アサイン（設定に基づく）

### 4. 完了 (finish)
```bash
unison-flow finish
```
1. PRのマージ確認
2. ブランチの削除
3. Linear issueのステータス更新
4. 必要に応じてedgeからmasterへのリリースPR作成を提案

## 状態遷移

```
[Not Started] --start--> [In Progress] --pr--> [In Review] --finish--> [Done]
                              |                      |
                              +------<commit>--------+
```

## 設定ファイル (.unison-flow.yml)

```yaml
# プロジェクト設定
project:
  linear_team_id: "TEAM-ID"
  default_reviewers: ["@reviewer1", "@reviewer2"]

# ブランチ設定
branches:
  production: "master"
  development: "edge"
  default: "master"

# ワークフロー設定
workflow:
  # issue タイプとブランチ戦略のマッピング
  issue_types:
    feature:
      base_branch: "edge"
      prefix: "feature"
    bug:
      base_branch: "edge"
      prefix: "fix"
    hotfix:
      base_branch: "master"
      prefix: "hotfix"
    
  # 自動化設定
  automation:
    auto_link_pr: true
    auto_update_status: true
    delete_branch_on_merge: true

# コミットメッセージテンプレート
commit:
  template: "[{issue_id}] {message}"
  
# PRテンプレート
pull_request:
  title_template: "[{issue_id}] {issue_title}"
  body_template: |
    ## 概要
    {issue_description}
    
    ## 変更内容
    - 
    
    ## テスト
    - [ ] ユニットテスト
    - [ ] 統合テスト
    
    Linear: {issue_url}
```

## コマンド一覧

| コマンド | 説明 | 例 |
|---------|------|-----|
| `start <issue-id>` | 新しいタスクを開始 | `unison-flow start UNI-123` |
| `status` | 現在の状態を表示 | `unison-flow status` |
| `commit -m <msg>` | issue IDを含めてコミット | `unison-flow commit -m "認証機能を追加"` |
| `pr` | PRを作成 | `unison-flow pr` |
| `finish` | タスクを完了 | `unison-flow finish` |
| `sync` | ベースブランチの最新を取り込む | `unison-flow sync` |
| `release` | edgeからmasterへのリリースPRを作成 | `unison-flow release` |

## エラーハンドリング

- Linear接続エラー: オフラインモードで継続
- Git競合: インタラクティブな解決ガイド
- 不正な状態遷移: 明確なエラーメッセージと修正方法の提示

---

最終更新: 2025年1月5日