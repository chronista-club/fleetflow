# Pre-PR チェックスキル

このスキルは、プルリクエスト作成前に必要なすべてのチェックを自動的に実行します。

## 目的

CI失敗を防ぎ、高品質なPRを作成するため、以下のチェックを順番に実行します:

1. フォーマットチェック (`cargo fmt`)
2. テスト実行 (`cargo test`)
3. リンティング (`cargo clippy`)
4. ドキュメント更新の確認
5. 変更サマリーの生成
6. PR作成の準備

## 実行手順

### Phase 1: 事前確認

**TodoWrite** を使用してタスクを管理します:

```
- 現在のブランチ確認
- mainからの差分確認
- コミット状況の確認
- フォーマットチェック
- テスト実行
- Clippyチェック
- ドキュメント更新確認
- 変更サマリー生成
- PR作成準備
```

### 1. 現在のブランチと状態を確認

```bash
git status
git branch --show-current
```

以下を確認:
- featureブランチにいるか（main/masterではない）
- コミットされていない変更がないか
- 現在のブランチ名が適切か

### 2. mainからの差分を確認

```bash
git fetch origin main
git log origin/main..HEAD --oneline
git diff origin/main --stat
```

変更されたファイルをリストアップし、影響範囲を把握します。

### 3. フォーマットチェック

```bash
cargo fmt --all -- --check
```

**成功時**: 次のステップへ進む

**失敗時**:
1. エラー内容を表示
2. `cargo fmt --all` で自動整形を実行
3. 整形されたファイルを確認
4. ユーザーに確認:「フォーマットを適用してコミットしますか？」
   - Yes → コミットして次へ
   - No → ユーザーが手動で対応するまで待機

### 4. テスト実行

```bash
cargo test --all
```

**成功時**: テスト結果のサマリーを表示し、次へ進む

**失敗時**:
1. 失敗したテストの詳細を表示
2. 失敗理由を分析
3. ユーザーに修正を提案
4. **中断**: テストが通るまでPR作成は進めない

### 5. Clippyチェック

```bash
cargo clippy --all -- -D warnings
```

**成功時**: 次のステップへ進む

**警告がある場合**:
1. 警告内容を表示
2. 各警告の重要度を評価
3. 修正が必要な警告をリストアップ
4. ユーザーに確認:「警告を修正しますか？」
   - Yes → 修正案を提示
   - No → ユーザー判断で続行

### 6. ドキュメント更新の確認

変更されたRustファイルに対応するドキュメントをチェック:

```bash
git diff origin/main --name-only | grep -E '\.(rs|toml)$'
```

変更されたファイルに基づいて、以下のドキュメントの更新が必要か確認:

| 変更ファイル | 確認すべきドキュメント |
|------------|---------------------|
| `crates/*/src/*.rs` | `design/`, `spec/` の対応する設計書・仕様書 |
| `Cargo.toml` | `README.md` (依存関係の変更) |
| `crates/fleetflow-cli/src/main.rs` | `spec/04-cli.md` |
| `crates/fleetflow-atom/src/parser.rs` | `design/01-kdl-parser.md`, `spec/07-kdl-syntax-reference.md` |

**実行内容**:
1. 変更ファイルをマッピング
2. 対応するドキュメントを **Read** ツールで読み込み
3. ドキュメントが最新の実装を反映しているか確認
4. 更新が必要な場合、ユーザーに通知
5. 更新が必要なドキュメントをリストアップ

### 7. 変更サマリーの生成

以下の情報を収集してサマリーを生成:

```bash
# コミット履歴
git log origin/main..HEAD --oneline

# 変更統計
git diff origin/main --stat

# 変更されたファイルの詳細
git diff origin/main
```

サマリーに含める情報:
- **変更の概要**: 何を実装したか（1-2文で）
- **実装内容**: 主要な変更点をリストアップ
- **技術的なポイント**: アーキテクチャや設計の重要な決定
- **テストカバレッジ**: 追加・変更されたテスト数
- **関連Issue**: `Closes #XX` 形式
- **破壊的変更**: あれば明記

### 8. PR作成の準備

すべてのチェックがパスした場合:

1. PR本文のドラフトを生成
2. 以下のテンプレートを使用:

```markdown
## 概要

[変更の概要 - 1-2文]

## 実装内容

- [主要な変更点1]
- [主要な変更点2]
- [主要な変更点3]

## 技術的なポイント

[アーキテクチャ・設計の重要な決定や実装の工夫]

## テスト

- 追加テスト: XX件
- 総テスト数: XX件
- カバレッジ: [変更部分のテスト状況]

## 関連ドキュメント

- `design/XX-XXX.md` - [更新内容]
- `spec/XX-XXX.md` - [更新内容]

## 関連Issue

Closes #XX

🤖 Generated with [Claude Code](https://claude.com/claude-code)
```

3. ユーザーに確認:「このPR本文でPRを作成しますか？」
   - Yes → `gh pr create` を実行
   - Edit → ユーザーが編集してから作成
   - No → PR本文を出力して終了（ユーザーが手動で作成）

### 9. PR作成

ユーザーの承認後:

```bash
gh pr create --title "[タイトル]" --body "$(cat <<'EOF'
[生成されたPR本文]
EOF
)"
```

作成後、PR URLを表示して完了。

## エラーハンドリング

各ステップでエラーが発生した場合:

1. **致命的エラー** (テスト失敗、Clippyエラーなど):
   - 即座に中断
   - エラー内容を詳細に表示
   - 修正方法を提案
   - ユーザーが修正するまで待機

2. **警告** (Clippy警告、ドキュメント未更新など):
   - 警告内容を表示
   - 続行するかユーザーに確認
   - ユーザーの判断で続行可能

3. **情報** (変更統計、コミット履歴など):
   - 情報を表示
   - 自動的に次のステップへ進む

## 使用ツール

- **Bash**: コマンド実行（git, cargo, gh）
- **TodoWrite**: タスク管理と進捗表示
- **Read**: ドキュメントの読み込み
- **Grep**: ファイル検索
- **AskUserQuestion**: ユーザーへの確認

## 成功基準

以下がすべて満たされた場合、PR作成を実行:

- [ ] フォーマットチェックがパス
- [ ] すべてのテストがパス
- [ ] Clippyチェックがパス（または警告を承認）
- [ ] 必要なドキュメントが更新されている（または更新不要を確認）
- [ ] 変更サマリーが生成されている
- [ ] ユーザーがPR作成を承認

## 注意事項

- このスキルは **自動的にコミットやプッシュを行いません**（フォーマット修正を除く）
- すべてのチェックを順番に実行し、失敗時は即座に中断します
- PR作成は最終的にユーザーの承認が必要です
- 並列実行は行わず、順次実行で確実性を優先します
