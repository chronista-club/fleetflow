# Pre-PR チェックスキル

## 概要

プルリクエスト作成前に必要なすべてのチェックを自動的に実行するスキルです。

## 目的

CI失敗を防ぎ、高品質なPRを作成するため、以下を実現します:

- **自動チェック**: フォーマット、テスト、リンティングを順番に実行
- **ドキュメント検証**: 変更に対応するドキュメントの更新を確認
- **変更サマリー**: PR本文の自動生成
- **エラー防止**: CI失敗の原因を事前に検出

## 使用方法

### 基本的な使い方

```
/pre-pr
```

または

```
スキルを使用: pre-pr-check
```

Claude Codeに「PR作成前のチェックを実行してください」と指示しても、このスキルが自動的に起動されます。

### 実行タイミング

以下のタイミングでこのスキルを使用してください:

1. **機能実装完了後**: 機能ブランチで実装が完了し、PRを作成する前
2. **レビュー指摘対応後**: レビューでの指摘を修正し、再度プッシュする前
3. **リベース後**: mainブランチの最新変更をマージした後

### 実行フロー

```
1. 現在のブランチ確認
   ↓
2. フォーマットチェック
   ↓ (失敗時は自動整形)
3. テスト実行
   ↓ (失敗時は中断)
4. Clippyチェック
   ↓ (警告時はユーザー確認)
5. ドキュメント更新確認
   ↓
6. 変更サマリー生成
   ↓
7. PR作成準備
   ↓ (ユーザー承認)
8. PR作成
```

## チェック項目

### 1. フォーマットチェック

- `cargo fmt --all -- --check` を実行
- 失敗時は自動整形を提案
- 整形されたファイルを確認してコミット

### 2. テスト実行

- `cargo test --all` を実行
- すべてのテストがパスすることを確認
- 失敗時は詳細を表示して中断

### 3. Clippyチェック

- `cargo clippy --all -- -D warnings` を実行
- 警告がある場合は内容を表示
- ユーザーに修正の要否を確認

### 4. ドキュメント更新確認

変更されたファイルに対応するドキュメントをチェック:

| ファイル | ドキュメント |
|---------|------------|
| `parser.rs` | `design/01-kdl-parser.md`, `spec/07-kdl-syntax-reference.md` |
| `main.rs` | `spec/04-cli.md` |
| `Cargo.toml` | `README.md` |

### 5. 変更サマリー生成

以下の情報を含むPR本文を生成:

- 変更の概要
- 実装内容
- 技術的なポイント
- テストカバレッジ
- 関連Issue

## エラーハンドリング

### 致命的エラー

以下の場合は即座に中断:

- テストが失敗
- Clippyでエラーが発生
- gitコマンドが失敗

### 警告

以下の場合はユーザーに確認:

- Clippyで警告が発生
- ドキュメントが未更新の可能性
- コミットされていない変更がある

### 情報

以下は情報として表示:

- 変更統計
- コミット履歴
- テスト結果サマリー

## 利点

### CI失敗の防止

- フォーマットエラーを事前検出
- テスト失敗を事前検出
- リンティング警告を事前検出

### PR品質の向上

- 包括的な変更サマリー
- ドキュメントとの整合性確保
- レビュアーに必要な情報を提供

### 時間の節約

- CI待機時間の削減
- 修正→プッシュ→CI失敗のループを防止
- 一度のチェックですべての問題を検出

## カスタマイズ

### チェック項目の追加

`skill.md` を編集して、プロジェクト固有のチェック項目を追加できます:

```markdown
### 10. カスタムチェック

カスタムチェックの説明...
```

### ドキュメントマッピングの変更

プロジェクトの構造に合わせて、ファイルとドキュメントのマッピングを変更できます。

## 制限事項

- このスキルは **読み取り専用チェック** が中心です
- 自動的なコミット・プッシュは最小限（フォーマット修正のみ）
- PR作成は最終的にユーザーの承認が必要
- 並列実行は行わず、順次実行で確実性を優先

## 関連リソース

- スラッシュコマンド版: `/pre-pr` - 手動でステップを実行する場合
- CI設定: `.github/workflows/` - CIと同じチェック項目を使用

## トラブルシューティング

### Q: フォーマットチェックが失敗する

A: `cargo fmt --all` を実行してから再度チェック

### Q: テストが失敗する

A: `cargo test --all` で詳細を確認し、テストを修正

### Q: Clippyで警告が出る

A: 警告内容を確認し、修正するか警告を承認

### Q: ドキュメントが未更新と指摘される

A: 対応するドキュメントを確認して更新するか、更新不要であることを確認

## 変更履歴

### 2025-11-23: 初版作成

- フォーマット、テスト、Clippyのチェックを実装
- ドキュメント更新確認を追加
- 変更サマリー生成を実装
- PR作成機能を追加
